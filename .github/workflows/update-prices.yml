name: Update prices daily

on:
  schedule:
    - cron: "0 19 * * *"  # 12:00 PM MST (19:00 UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build prices.json from Stooq daily close
        run: |
          python3 - << 'PY'
          import csv, json, datetime, urllib.request

          # Read tickers from portfolio.csv
          tickers=[]
          with open("portfolio.csv","r",newline="") as f:
            r=csv.DictReader(f)
            for row in r:
              tickers.append(row["ticker"].strip().upper())

          # Stooq uses different symbols for some assets.
          # Common US stocks: AAPL.US, NVDA.US
          # ETFs often work too: QQQ.US, VOO.US, etc.
          def stooq_symbol(t):
            return f"{t.lower()}.us"

          prices={}
          missing=[]
          for t in tickers:
            sym=stooq_symbol(t)
            url=f"https://stooq.com/q/l/?s={sym}&f=sd2t2ohlcv&h&e=csv"
            try:
              data=urllib.request.urlopen(url,timeout=20).read().decode("utf-8").splitlines()
              # CSV header: Symbol,Date,Time,Open,High,Low,Close,Volume
              rows=list(csv.DictReader(data))
              if not rows or rows[0].get("Close") in (None,"","-"):
                missing.append(t); continue
              close=float(rows[0]["Close"])
              prices[t]=close
            except Exception:
              missing.append(t)

          out={
            "asOf": datetime.date.today().isoformat(),
            "prices": prices,
            "missing": missing
          }

          with open("prices.json","w") as f:
            json.dump(out,f,indent=2)

          if missing:
            print("Missing tickers:", missing)
          PY

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add prices.json
          git commit -m "Daily price update" || echo "No changes"
          git push
